<section class="">
    <div class="title-gb no-padding">
        <div class="mgn-up-15 mgn-lt-15 mgn-rt-15 dash-head">
            Inbox
            <i class="fa fa-question-circle-o fa-lg fl-right" (click)="redirecToHelp()"></i>
        </div>
    </div>
</section>
<section>
    <div class="content comn-cls">
        <div class="col-md-12 no-padding-small">
            <div class="card p0">
                <!-- <div class="copy">
                        <ul class="inbox-table" *ngIf="messages.length>0 && !loading">
                            <li class="ttd" [class.active]="selectedMsg==i"
                                [class.outer-received]="isRecievedOrSent(message) === 'receive'"
                                [class.outer-sent]="isRecievedOrSent(message) === 'sent'"
                                *ngFor="let message of messages; let i = index">
                                <div class="outer" (click)="showMsg(i, message)">
                                    <div class="td td0">
                                        <span class="icon-inbox-in" *ngIf="isRecievedOrSent(message) === 'receive'"></span>
                                        <span class="icon-inbox-out" *ngIf="isRecievedOrSent(message) === 'sent'"></span>
                                    </div>
                                    <div class="td td0" *ngIf="message.attachements && message.attachements.length > 0">
                                        <span class="result" *ngIf="message.attachements && message.attachements.length > 0" [matTooltipClass]="tooltipcls"
                                            [matTooltip]="fileTooltip"><i class="fa fa-file-text-o"
                                                aria-hidden="true"></i>
                                        </span>
                                    </div>
                                    <div class="td td3" [class.inbox-unreadmsg]="!message.read && isRecievedOrSent(message) === 'receive'">
                                        <div class="result" *ngIf="isRecievedOrSent(message) === 'receive'">{{message.owner.name | capitalizeFirst}}
                                        </div>
                                        <div class="result" *ngIf="isRecievedOrSent(message) === 'sent'">{{message.receiver.name | capitalizeFirst}}
                                        </div>
                                    </div>
                                    <div class="td td2" [class.inbox-unreadmsg]="!message.read && isRecievedOrSent(message) === 'receive'">
                                        <div class="result" *ngIf="message.service && message.service !== null">
                                            {{ (message.service.length>50)? (wordProcessor.firstToUpper(message.service) | slice:0:40)+'.....':wordProcessor.firstToUpper(message.service) }}
                                        </div>
                                        <div class="result" *ngIf="!message.service || message.service === null">-</div>
                                    </div>
                                    <div class="td td4" [class.inbox-unreadmsg]="!message.read && isRecievedOrSent(message) === 'receive'">
                                        <div class="result"  *ngIf= "message && message.msg">
                                            {{ (message.msg.length>30)? (wordProcessor.firstToUpper(message.msg) | slice:0:39)+'.....':wordProcessor.firstToUpper(message.msg) }}
                                        </div>
                                    </div>
                                    <div class="td td1" [class.inbox-unreadmsg]="!message.read && isRecievedOrSent(message) === 'receive'">
                                        <div class="result">{{formatDateDisplay(message.timeStamp)}}</div>
                                    </div>
                                </div>
                                <div class="details" [class.show]="selectedMsg==i">
                                    <div class="result">
                                        <div class="result" [innerHTML]="message.msg | nl2br | capitalizeFirst">
                                        </div>
                                        <div class="result attach" *ngIf="message.attachements && message.attachements.length > 0"
                                            (click)="showImagesection(i)">
                                            <i class="fa fa-file-text-o" aria-hidden="true"></i> <a class="attach-link">
                                                {{message.attachements.length}} Attachment(s) </a>
                                        </div>
                                        <div class="thumbnails mt10 mb10" *ngIf="showImages[i]">
                                            <a class="mg-10" target="_blank" [href]="attachment.s3path"
                                                *ngFor="let attachment of message.attachements"><img
                                                    [src]="getThumbUrl(attachment)"
                                                    style="width:100px; height:100px" /></a>
                                        </div>
                                        <div class="action">
                                            <span class="icon-reply" (click)="replyMessage(message)"
                                                *ngIf="isRecievedOrSent(message) === 'receive'">
                                                {{reply_cap}}
                                            </span>
                                            <span class="icon-close" (click)="closeMsg()">
                                                {{close_cap}}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="actions">
                                        <span class="icon-delete"> {{delete_msg_cap}}</span>
                                    </div>
                                </div>
                            </li>
                        </ul>
                        <div style="padding-left: 20px" *ngIf="this.messages.length == 0 && !loading">
                            <p>{{no_msg_exists_cap}}</p>
                        </div>
                        <app-common-innerloading-spinner *ngIf="loading"> </app-common-innerloading-spinner>
                    </div> -->






                <app-common-innerloading-spinner *ngIf="loading"></app-common-innerloading-spinner>
                <div class="d-flex flex-column flex-column-fluid" id="kt_content" *ngIf="!loading">
                    <!--begin::Entry-->







                    <div class="d-flex flex-column-fluid">
                        <!--begin::Container-->
                        <div class=" container no-padding">
                            <!--begin::Chat-->
                            <div class="d-flex flex-row">
                                <!--begin::Aside-->
                                <div class="flex-row-auto card-width w-xl-400px" id="kt_chat_aside" *ngIf="!showChat">
                                    <!--begin::Card-->
                                    <div class="card card-custom">


                                        <div>
                                            <button mat-flat-button (click)="changemsgDisplayType('all')">All</button>
                                            <button mat-flat-button (click)="changemsgDisplayType('user')"
                                                *ngIf="userDet && userDet.accountType === 'BRANCH'">Users</button>
                                        </div>


                                        <div class="user-section" *ngIf="msgDisplay=='user'">
                                                <ng-container *ngFor="let user of users">
                                                    <div class="pad-10 pointer-cursor" *ngIf="groupedMsgsbyUser[(user.businessName) ? user.businessName : user.firstName+' '+user.lastName]"
                                                        (click)="userSelection(user)">
                                                <div class="user-name">
                                                    {{getUser((user.businessName) ? user.businessName : user.firstName +
                                                    ' ' +
                                                    user.lastName, 'user')}}
                                                </div>
                                                {{(user.businessName) ? user.businessName : user.firstName + ' ' +
                                                user.lastName}}
                                            </div>
                                            </ng-container>
                                        </div>


                                        <!--begin::Body-->
                                        <div class="card-body">
                                            <!--begin:Users-->
                                            <div class="scroll scroll-pull over-scroll" [ngStyle]="{'height.vh': 75}">
                                                <!--begin:User-->


                                                <div *ngFor="let user of groupedMsgs | keyvalue: valueOrder"
                                                    (click)="customerSelection(user)"
                                                    class="d-flex align-items-center justify-content-between pointer-cursor pad-5"
                                                    [class.selected-user]="selectedCustomer==user.key">
                                                    <div class="d-flex align-items-center">
                                                        <div class="symbol symbol-circle symbol-50 mr-3">
                                                            <div class="user-name">
                                                                {{getUser(user.key)}}
                                                            </div>
                                                        </div>
                                                        <div class="d-flex flex-column">
                                                            <a
                                                                class="text-dark-75 text-hover-primary font-weight-bold font-size-lg">
                                                                {{getUserName(user.key, 'customer')}}</a>
                                                            <span class="text-muted font-weight-bold font-size-sm">
                                                                {{formatDateDisplay(user.value[user.value.length-1].timeStamp)}}</span>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex flex-column align-items-end">
                                                        <span
                                                            class="text-muted font-weight-bold font-size-sm">{{getUserName(user.key,
                                                            'provider')}}</span>
                                                        <span class="label label-sm label-success"
                                                            *ngIf="getUnreadCount(user.value) > 0">{{getUnreadCount(user.value)}}</span>
                                                    </div>
                                                </div>

                                                <!--end:User-->
                                            </div>
                                            <!--end:Users-->
                                        </div>
                                        <!--end::Body-->
                                    </div>
                                    <!--end::Card-->
                                </div>
                                <!--end::Aside-->
                                <!--begin::Content-->
                                <div class="flex-row-fluid ml-lg-8" id="kt_chat_content"
                                    *ngIf="(selectedCustomer != '' && !small_device_display) || (small_device_display && showChat)">
                                    <!--begin::Card-->
                                    <div class="card card-custom">
                                        <!--begin::Header-->
                                        <div class="card-header align-items-center px-4 py-3">
                                            <div class="text-center flex-grow-1">
                                                <div class="text-left flex-grow-1">
                                                    <!--begin::Aside Mobile Toggle-->
                                                    <button type="button"
                                                        class="btn btn-clean btn-sm btn-icon btn-icon-md d-md-none"
                                                        id="kt_app_chat_toggle" (click)="showChatSection()">
                                                        <span class="svg-icon svg-icon-lg">
                                                            <!--begin::Svg Icon | path:assets/media/svg/icons/Communication/Adress-book2.svg--><svg
                                                                xmlns="http://www.w3.org/2000/svg"
                                                                xmlns:xlink="http://www.w3.org/1999/xlink" width="24px"
                                                                height="24px" viewBox="0 0 24 24" version="1.1">
                                                                <g stroke="none" stroke-width="1" fill="none"
                                                                    fill-rule="evenodd">
                                                                    <rect x="0" y="0" width="24" height="24" />
                                                                    <path
                                                                        d="M18,2 L20,2 C21.6568542,2 23,3.34314575 23,5 L23,19 C23,20.6568542 21.6568542,22 20,22 L18,22 L18,2 Z"
                                                                        fill="#000000" opacity="0.3" />
                                                                    <path
                                                                        d="M5,2 L17,2 C18.6568542,2 20,3.34314575 20,5 L20,19 C20,20.6568542 18.6568542,22 17,22 L5,22 C4.44771525,22 4,21.5522847 4,21 L4,3 C4,2.44771525 4.44771525,2 5,2 Z M12,11 C13.1045695,11 14,10.1045695 14,9 C14,7.8954305 13.1045695,7 12,7 C10.8954305,7 10,7.8954305 10,9 C10,10.1045695 10.8954305,11 12,11 Z M7.00036205,16.4995035 C6.98863236,16.6619875 7.26484009,17 7.4041679,17 C11.463736,17 14.5228466,17 16.5815,17 C16.9988413,17 17.0053266,16.6221713 16.9988413,16.5 C16.8360465,13.4332455 14.6506758,12 11.9907452,12 C9.36772908,12 7.21569918,13.5165724 7.00036205,16.4995035 Z"
                                                                        fill="#000000" />
                                                                </g>
                                                            </svg>
                                                            <!--end::Svg Icon-->
                                                        </span> </button>
                                                    <!--end::Aside Mobile Toggle-->
                                                </div>
                                                <div class="text-dark-75 font-weight-bold font-size-h5">
                                                    {{getUserName(selectedCustomer, 'customer')}}</div>
                                            </div>
                                        </div>
                                        <!--end::Header-->
                                        <!--begin::Body-->
                                        <div class="card-body no-padding-small">
                                            <!--begin::Scroll-->
                                            <div class="scroll scroll-pull over-scroll" #scrollMe
                                                [ngStyle]="{'height.vh': 50}">
                                                <!--begin::Messages-->
                                                <div class="messages" *ngFor="let msg of selectedUserMessages">
                                                    <!--begin::Message In-->
                                                    <div *ngIf="msg.messagestatus==='in'"
                                                        class="d-flex flex-column mb-5 align-items-start">
                                                        <div class="d-flex align-items-center">
                                                            <div>
                                                                <span
                                                                    class="text-muted font-size-sm">{{formatDateDisplay(msg.timeStamp)}}</span>
                                                            </div>
                                                        </div>
                                                        <div
                                                            class="mt-2 rounded p-5 bg-light-success text-dark-50 font-weight-bold font-size-lg text-left msg-width">
                                                            {{msg.msg}}
                                                            <div class="thumbnails mt10 mb10" *ngIf="msg.attachements">
                                                                <a class="mg-10"
                                                                    (click)="openImage(msg.attachements, i)"
                                                                    *ngFor="let attachment of msg.attachements;let i=index"><img
                                                                        [src]="getThumbUrl(attachment)" /></a>
                                                            </div>

                                                        </div>
                                                    </div>
                                                    <!--end::Message In-->
                                                    <!--begin::Message Out-->
                                                    <div *ngIf="msg.messagestatus==='out'"
                                                        class="d-flex flex-column mb-5 align-items-end">
                                                        <div class="d-flex align-items-center">
                                                            <div>
                                                                <span
                                                                    class="text-muted font-size-sm">{{formatDateDisplay(msg.timeStamp)}}</span>
                                                            </div>
                                                        </div>
                                                        <div
                                                            class="mt-2 rounded p-5 bg-light-primary text-dark-50 font-weight-bold font-size-lg text-right msg-width">
                                                            {{msg.msg}}
                                                            <div class="thumbnails mt10 mb10" *ngIf="msg.attachements">
                                                                <a class="mg-10"
                                                                    (click)="openImage(msg.attachements, i)"
                                                                    *ngFor="let attachment of msg.attachements;let i=index"><img
                                                                        [src]="getThumbUrl(attachment)" /></a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!--end::Message Out-->
                                                </div>
                                                <!--end::Messages-->
                                            </div>
                                            <!--end::Scroll-->
                                        </div>
                                        <!--end::Body-->
                                        <!--begin::Footer-->
                                        <div class="card-footer align-items-center">
                                            <!--begin::Compose-->
                                            <div class="d-flex align-items-center justify-content-between mt-5">
                                                <textarea class="form-control border-0 p-0" placeholder="Type a message"
                                                    [(ngModel)]="message"></textarea>
                                                <div class="mr-3">
                                                    <input #logofile type="file" accept="/*;capture=camera"
                                                        style="display:none;" multiple (change)="filesSelected($event)">
                                                    <a class="btn btn-clean btn-icon btn-md"
                                                        (click)="logofile.click()"><i
                                                            class="material-icons">attach_file</i></a>
                                                </div>
                                                <div>
                                                    <button type="button"
                                                        (click)="sendMessageCompleted && sendMessage()"
                                                        *ngIf="!small_device_display"
                                                        class="btn btn-primary btn-md text-uppercase font-weight-bold chat-send py-2 px-6 disp-flex">Send
                                                    </button>
                                                    <i *ngIf="small_device_display"
                                                        (click)="sendMessageCompleted && sendMessage()"
                                                        class="fa fa-paper-plane" aria-hidden="true"></i>
                                                </div>
                                            </div>
                                            <div class="img-section mgn-up-20"
                                                *ngIf="selectedMessage.files && selectedMessage.files.length > 0">
                                                <ul class="galul">
                                                    <li *ngFor="let file of selectedMessage.files;let i = index ">
                                                        <div class="galimg_outer">
                                                            <div class="gal_img">
                                                                <img [src]="selectedMessage.base64[i]"
                                                                    *ngIf="selectedMessage.base64[i]">
                                                            </div>
                                                            <div class="gal_action" (click)="deleteTempImage(i)">
                                                                <i class="fa fa-times-circle" aria-hidden="true"></i>
                                                            </div>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>
                                            <!--begin::Compose-->
                                        </div>
                                        <!--end::Footer-->
                                    </div>
                                    <!--end::Card-->
                                </div>
                                <!--end::Content-->
                            </div>
                            <!--end::Chat-->
                        </div>
                        <!--end::Container-->
                    </div>
                    <!--end::Entry-->
                </div>


            </div>
        </div>
    </div>
</section>